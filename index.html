<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ordini</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #0077b6;
      margin-bottom: 20px;

    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background-color: #f97316;
      color: white;
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      padding: 8px 12px;
      background-color: #0077b6;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #023e8a;
    }
    #extraPopup {
      display: none;
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #0077b6;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      width: 90%;
      max-width: 500px;
    }
    #extraPopup h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #extraPopup input {
      width: 100%;
    }
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
      }
      table, th, td {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <button onclick="openCarrelloPopup()">ðŸ›’ Vedi Carrello</button>

<!-- POPUP CARRELLO -->
<div id="carrelloPopup" class="popup">
  <div class="popup-content">
    <h2>
      Carrello
      <button onclick="closeCarrelloPopup()">Ã—</button>
    </h2>
    <table id="carrelloTable">
      <thead>
        <tr>
          <th>Codice</th>
          <th>Descrizione</th>
          <th>QuantitÃ </th>
          <th>P.P.</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<h1>Ordini</h1>

<div class="controls">
  <input type="text" id="cliente" placeholder="Nome cliente" />
  <input type="text" id="search" placeholder="Cerca..." />
  <button onclick="generateExcel()">Genera XLS</button>
  <button id="openExtraBtn">+ Articoli Extra</button>
</div>

<table id="catalogoTable">
  <thead>
    <tr>
      <th>Codice</th>
      <th>Descrizione</th>
      <th>QuantitÃ </th>
      <th>P.P.</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- POPUP ARTICOLI EXTRA -->
<div id="extraPopup">
  <h2>
    Articoli Extra
    <button onclick="closeExtraPopup()">Ã—</button>
  </h2>
  <table id="extraTable">
    <thead>
      <tr>
        <th>Codice</th>
        <th>Descrizione</th>
        <th>QuantitÃ </th>
        <th>P.P.</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" placeholder="Codice" /></td>
        <td><input type="text" placeholder="Descrizione" /></td>
        <td><input type="number" placeholder="CT" /></td>
        <td><input type="number" placeholder="P.P." /></td>
      </tr>
    </tbody>
  </table>
  <button onclick="addExtraRow()">+ Aggiungi Riga</button>
</div>


<script>
  const inputData = {};

  async function loadCSVFromGitHub() {
    const url = "https://raw.githubusercontent.com/mosynaa/ordinecil/main/catalogo.csv";
    const response = await fetch(url);
    const text = await response.text();
    const rows = text.trim().split("\n").slice(1).map(row => row.split(","));
    const tbody = document.querySelector("#catalogoTable tbody");
    tbody.innerHTML = "";

    rows.forEach(([codice, descrizione, categoria, prezzo]) => {
      const row = document.createElement("tr");

      const qtKey = `qt_${codice}`;
      const ppKey = `pp_${codice}`;

      row.innerHTML = `
        <td>${codice}</td>
        <td>${descrizione}</td>
        <td><input type="number" placeholder="CT" value="${inputData[qtKey] || ""}" oninput="inputData['${qtKey}']=this.value" /></td>
        <td><input type="number" placeholder="P.P." value="${inputData[ppKey] || ""}" oninput="inputData['${ppKey}']=this.value" /></td>
      `;
      tbody.appendChild(row);
    });
  }

  document.getElementById("search").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("#catalogoTable tbody tr");
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  });

  function generateExcel() {
    const cliente = document.getElementById("cliente").value || "Cliente";
    const wb = XLSX.utils.book_new();
    const data = [["Codice", "Descrizione", "QuantitÃ ", "P.P."]];

    document.querySelectorAll("#catalogoTable tbody tr").forEach(row => {
      const codice = row.cells[0].textContent.trim();
      const descrizione = row.cells[1].textContent.trim();
      const qt = row.cells[2].querySelector("input").value || "";
      const pp = row.cells[3].querySelector("input").value || "";
      if (qt || pp) data.push([codice, descrizione, qt, pp]);
    });

    document.querySelectorAll("#extraTable tbody tr").forEach(row => {
      const codice = row.cells[0].querySelector("input").value || "";
      const descrizione = row.cells[1].querySelector("input").value || "";
      const qt = row.cells[2].querySelector("input").value || "";
      const pp = row.cells[3].querySelector("input").value || "";
      if (qt || pp) data.push([codice, descrizione, qt, pp]);
    });

    const ws = XLSX.utils.aoa_to_sheet([[`Cliente: ${cliente}`], [], ...data]);
    XLSX.utils.book_append_sheet(wb, ws, "Ordine");
    XLSX.writeFile(wb, `${cliente.replace(/\s+/g, "_")}_ordine.xlsx`);
  }

  function openExtraPopup() {
    document.getElementById("extraPopup").style.display = "block";
  }

  function closeExtraPopup() {
    document.getElementById("extraPopup").style.display = "none";
  }

  function addExtraRow() {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" placeholder="Codice" /></td>
      <td><input type="text" placeholder="Descrizione" /></td>
      <td><input type="number" placeholder="CT" /></td>
      <td><input type="number" placeholder="P.P." /></td>
    `;
    document.querySelector("#extraTable tbody").appendChild(row);
  }

  document.getElementById("openExtraBtn").addEventListener("click", openExtraPopup);
  window.onload = loadCSVFromGitHub;
</script>

</body>
</html>
